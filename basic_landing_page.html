// SIMAK-like Student Portal for UNKRIS (Hukum Internasional Version)
// Single-file React component (complete, fixed syntax)
// TailwindCSS classes are referenced; ensure Tailwind is available in the project.

import React, { useEffect, useState } from "react";

// -------------------- Mock API helpers --------------------
const api = {
  login: async (nim, password) => {
    // demo credentials: nim 9902508140 / password 123
    if (nim === "9902508140" && password === "123")
      return { ok: true, token: "mock-token", name: "Rayhan Ravie Ramadhan Hasibuan", nim, prodi: "Hukum Internasional" };
    return { ok: false, message: "NIM atau password salah" };
  },
  fetchDashboard: async () => ({ name: "Rayhan Ravie Ramadhan Hasibuan", nim: "9902508140", prodi: "Hukum Internasional", ips: null, sksTempuh: 18, nextRegistration: "2026-01-10" }),
  fetchCourses: async () => [
    { code: "HI101", name: "Hukum Internasional Publik", sks: 3, semester: 1 },
    { code: "HI201", name: "Hak Asasi Manusia", sks: 3, semester: 3 },
    { code: "HI301", name: "Hukum Laut Internasional", sks: 3, semester: 5 },
  ],
  fetchGrades: async () => {
    const r = () => Math.floor(Math.random() * 15) + 80;
    return [
      { code: "H1502", name: "Ilmu Negara", uts: r() },
      { code: "H1503", name: "Bahasa Inggris Hukum", uts: r() },
      { code: "H1501", name: "Pengantar Ilmu Hukum", uts: r() },
      { code: "H1504", name: "Bahasa Indonesia", uts: r() },
      { code: "H1505", name: "Ilmu Hukum Asasi", uts: r() },
      { code: "H1611", name: "Hukum dan Masyarakat", uts: r() },
      { code: "H14102", name: "Pendidikan Pancasila", uts: r() },
      { code: "H1101", name: "Pendidikan Agama", uts: r() },
      { code: "H1203", name: "Pendidikan Kewarganegaraan", uts: r() },
    ];
  },
  fetchSchedule: async () => [
    { day: "Senin", time: "09.00 – 10.30", room: "301", course: "Ilmu Negara", className: "Reg 1", lecturer: "Risanti Haryati, S.H., M.H." },
    { day: "Senin", time: "10.30 – 12.00", room: "301", course: "Bahasa Inggris Hukum", className: "Reg 1", lecturer: "Anwar Shouibbing, S.Pd., M.H." },
    { day: "Selasa", time: "10.30 – 12.00", room: "301", course: "Pengantar Ilmu Hukum", className: "Reg 1", lecturer: "Yossy Kusumadewi, S.H., M.H." },
    { day: "Rabu", time: "10.00 – 11.00", room: "301", course: "Bahasa Indonesia", className: "Reg 1", lecturer: "Brigjen TNI (Purn) Satrio Rahardjo, S.H." },
    { day: "Rabu", time: "11.30 – 12.30", room: "301", course: "Ilmu Hukum Asasi", className: "Reg 1", lecturer: "Prof. Dr. Tatik Koesmaryati, S.H., M.H." },
    { day: "Kamis", time: "09.00 – 10.30", room: "301", course: "Hukum dan Masyarakat", className: "Reg 1", lecturer: "Diah Turis Kasmirawati, S.H., M.H." },
    { day: "Kamis", time: "10.30 – 12.00", room: "301", course: "Pendidikan Pancasila", className: "Reg 1", lecturer: "Dra. Rr. Endang Sri Sulasih, M.Pd., M.H." },
    { day: "Jumat", time: "13.00 – 14.30", room: "301", course: "Pendidikan Agama", className: "Reg 1", lecturer: "Adham, S.H.I., M.H." },
    { day: "Jumat", time: "14.45 – 16.00", room: "301", course: "Pendidikan Kewarganegaraan", className: "Reg 1", lecturer: "Dra. Rr. Endang Sri Sulasih, M.Pd., M.H." },
  ],
  fetchAnnouncements: async () => [
    { id: 1, title: "Registrasi KRS Dibuka", date: "2025-12-01", body: "Registrasi KRS semester genap dibuka mulai 10 Jan 2026." },
    { id: 2, title: "Ujian Akhir Semester (UAS)", date: "2025-11-20", body: "UAS akan berlangsung 10 - 17 Desember 2025." },
  ],
  fetchBills: async () => [
    {
      id: 1,
      description: "Semester Ganjil 2025/2026",
      total: 9000000,
      installments: [
        { number: 1, amount: 1800000, status: "Lunas", va: "887181209580404", billCode: "2025/FH/1/074", dueDate: "2025-07-20", detail: "Pembayaran Cicilan 1" },
        { number: 2, amount: 1800000, status: "Lunas", va: "887181209580404", billCode: "2025/FH/2/074", dueDate: "2025-08-20", detail: "Pembayaran Cicilan 2" },
        { number: 3, amount: 1800000, status: "Lunas", va: "887181209580404", billCode: "2025/FH/3/074", dueDate: "2025-09-20", detail: "Pembayaran Cicilan 3" },
        { number: 4, amount: 1800000, status: "Lunas", va: "887181209580404", billCode: "2025/FH/4/074", dueDate: "2025-10-20", detail: "Pembayaran Cicilan 4" },
        { number: 5, amount: 1800000, status: "Belum Lunas", va: "887181209580404", billCode: "2025/FH/5/074", dueDate: "2025-11-20", detail: "Pembayaran Cicilan 5" },
      ],
    },
  ],
};

export default function UnkrisPortal() {
  const [route, setRoute] = useState("/login");
  const [token, setToken] = useState(null);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(false);

  const [dashboard, setDashboard] = useState(null);
  const [courses, setCourses] = useState([]);
  const [grades, setGrades] = useState([]);
  const [schedule, setSchedule] = useState([]);
  const [announcements, setAnnouncements] = useState([]);
  const [bills, setBills] = useState([]);

  useEffect(() => {
    if (token) loadAll();
  }, [token]);

  async function loadAll() {
    setLoading(true);
    try {
      const [d, c, g, s, a, b] = await Promise.all([
        api.fetchDashboard(),
        api.fetchCourses(),
        api.fetchGrades(),
        api.fetchSchedule(),
        api.fetchAnnouncements(),
        api.fetchBills(),
      ]);
      setDashboard(d);
      setCourses(c);
      setGrades(g);
      setSchedule(s);
      setAnnouncements(a);
      setBills(b);
    } finally {
      setLoading(false);
    }
  }

  // -------------------- Shared Components --------------------
  function Nav() {
    return (
      <nav className="bg-red-600 text-white p-4 flex justify-between items-center">
        <div className="flex items-center gap-3">
          <div className="font-bold">UNKRIS • SIMAK</div>
          <div className="text-sm opacity-80">Portal Mahasiswa</div>
        </div>
        <div className="flex items-center gap-3">
          {token ? (
            <>
              <button onClick={() => setRoute("/dashboard")} className="hover:underline">Dashboard</button>
              <button onClick={() => setRoute("/krs")} className="hover:underline">KRS</button>
              <button onClick={() => setRoute("/nilai")} className="hover:underline">Nilai</button>
              <button onClick={() => setRoute("/jadwal")} className="hover:underline">Jadwal</button>
              <button onClick={() => setRoute("/tagihan")} className="hover:underline">Tagihan</button>
              <button onClick={() => setRoute("/pengumuman")} className="hover:underline">Pengumuman</button>
              <button onClick={() => setRoute("/profile")} className="hover:underline">Profil</button>
              <button onClick={() => { setToken(null); setUser(null); setRoute('/login'); }} className="bg-white text-red-600 px-3 py-1 rounded">Logout</button>
            </>
          ) : null}
        </div>
      </nav>
    );
  }

  // -------------------- Views (defined) --------------------
  function Login() {
    const [nim, setNim] = useState("");
    const [password, setPassword] = useState("");
    const [err, setErr] = useState(null);

    async function handleLogin(e) {
      e.preventDefault();
      setErr(null);
      setLoading(true);
      try {
        const res = await api.login(nim, password);
        if (res.ok) {
          setToken(res.token);
          setUser({ name: res.name, nim: res.nim, prodi: res.prodi });
          setRoute("/dashboard");
        } else {
          setErr(res.message || "Gagal login");
        }
      } catch (err) {
        setErr('Terjadi kesalahan saat login');
      } finally {
        setLoading(false);
      }
    }

    return (
      <div className="min-h-[70vh] flex items-center justify-center">
        <div className="w-full max-w-md bg-white p-6 rounded shadow">
          <h2 className="text-2xl font-bold mb-4">Login Mahasiswa UNKRIS</h2>
          <form onSubmit={handleLogin} className="space-y-3">
            <div>
              <label className="text-sm">NIM</label>
              <input value={nim} onChange={(e) => setNim(e.target.value)} className="w-full border px-3 py-2 rounded" placeholder="9902508140" />
            </div>
            <div>
              <label className="text-sm">Password</label>
              <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full border px-3 py-2 rounded" />
            </div>
            {err && <div className="text-red-600">{err}</div>}
            <div className="flex items-center justify-between">
              <button disabled={loading} className="bg-red-600 text-white px-4 py-2 rounded">{loading ? 'Loading...' : 'Masuk'}</button>
              <button type="button" onClick={() => { setNim('9902508140'); setPassword('123'); }} className="text-sm underline">Auto-login</button>
            </div>
          </form>
        </div>
      </div>
    );
  }

  function DashboardView() {
    if (!dashboard) return <div className="p-6">Memuat dashboard...</div>;
    return (
      <div className="p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="md:col-span-2 bg-white p-4 rounded shadow">
          <h3 className="text-xl font-bold">Halo, {dashboard.name}</h3>
          <p className="text-sm opacity-80">NIM: {dashboard.nim} — Prodi: {dashboard.prodi}</p>

          <div className="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div className="p-3 border rounded">
              <div className="text-xs text-gray-500">IPS Terakhir</div>
              <div className="text-2xl font-bold">{dashboard.ips || '-'}</div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-gray-500">SKS Tempuh</div>
              <div className="text-2xl font-bold">{dashboard.sksTempuh}</div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-gray-500">Registrasi Berikutnya</div>
              <div className="text-2xl font-bold">{dashboard.nextRegistration}</div>
            </div>
          </div>

          <div className="mt-6">
            <h4 className="font-semibold">Pengumuman Terbaru</h4>
            {announcements.slice(0, 3).map(a => (
              <div key={a.id} className="mt-3 p-3 border rounded">
                <div className="text-sm font-semibold">{a.title}</div>
                <div className="text-xs opacity-70">{a.date}</div>
                <div className="text-sm mt-1">{a.body}</div>
              </div>
            ))}
          </div>
        </div>

        <div className="bg-white p-4 rounded shadow">
          <h4 className="font-semibold">Aksi Cepat</h4>
          <div className="mt-3 flex flex-col gap-2">
            <button onClick={() => setRoute('/krs')} className="w-full border px-3 py-2 rounded text-left">Daftar KRS</button>
            <button onClick={() => setRoute('/nilai')} className="w-full border px-3 py-2 rounded text-left">Lihat Nilai</button>
            <button onClick={() => setRoute('/jadwal')} className="w-full border px-3 py-2 rounded text-left">Lihat Jadwal</button>
            <button onClick={() => setRoute('/tagihan')} className="w-full border px-3 py-2 rounded text-left">Lihat Tagihan</button>
            <button onClick={() => setRoute('/pengumuman')} className="w-full border px-3 py-2 rounded text-left">Lihat Pengumuman</button>
            <a href={`https://wa.me/6281216138686?text=Halo%20Admin%20UNKRIS,%20saya%20butuh%20bantuan`} target="_blank" rel="noreferrer" className="w-full inline-block text-center border px-3 py-2 rounded">Hubungi Admin (WhatsApp)</a>
          </div>
        </div>
      </div>
    );
  }

  function KRSView() {
    const [selected, setSelected] = useState([]);
    function toggle(code) { setSelected(prev => prev.includes(code) ? prev.filter(x => x !== code) : [...prev, code]); }
    function submitKRS() { alert('KRS tersubmit: ' + selected.join(', ')); }
    return (
      <div className="p-6">
        <h3 className="text-xl font-bold">Form KRS</h3>
        <div className="mt-4 grid gap-3">
          {courses.map(c => (
            <div key={c.code} className="p-3 border rounded flex justify-between items-center bg-white">
              <div>
                <div className="font-semibold">{c.code} — {c.name}</div>
                <div className="text-sm opacity-70">{c.sks} SKS • Semester {c.semester}</div>
              </div>
              <label className="inline-flex items-center">
                <input type="checkbox" checked={selected.includes(c.code)} onChange={() => toggle(c.code)} className="mr-2" />
                Pilih
              </label>
            </div>
          ))}
          <div className="mt-3">
            <button onClick={submitKRS} className="bg-red-600 text-white px-4 py-2 rounded">Submit KRS</button>
          </div>
        </div>
      </div>
    );
  }

  function NilaiView() {
    return (
      <div className="p-6">
        <h3 className="text-xl font-bold">Nilai Akademik</h3>
        <div className="mt-4 bg-white p-3 rounded shadow">
          <table className="w-full table-auto">
            <thead>
              <tr className="text-left">
                <th className="p-2 text-center">Kode</th>
                <th className="p-2 text-center">Mata Kuliah</th>
                <th className="p-2 text-center">Nilai UTS</th>
              </tr>
            </thead>
            <tbody>
              {grades.map(g => (
                <tr key={g.code} className="border-t">
                  <td className="p-2 text-center">{g.code}</td>
                  <td className="p-2 text-center">{g.name}</td>
                  <td className="p-2 text-center">{g.uts}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  }

  function JadwalView() {
    return (
      <div className="p-6">
        <h3 className="text-xl font-bold">Jadwal Perkuliahan</h3>
        <div className="mt-4 grid gap-3">
          {schedule.map((s, idx) => (
            <div key={idx} className="p-3 border rounded bg-white">
              <div className="font-semibold">{s.course}</div>
              <div className="text-sm opacity-70">{s.day} • {s.time} • Ruang {s.room} • {s.className} • {s.lecturer}</div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  function TagihanView() {
    function onClickInstallment(inst) {
      // show VA and description when a cicilan is clicked
      alert(`Cicilan ${inst.number}
Status: ${inst.status}
Jumlah: Rp ${inst.amount.toLocaleString()}
VA: ${inst.va}
Kode: ${inst.billCode}
Deskripsi: ${inst.detail}`);
    }

    return (
      <div className="p-6">
        <h3 className="text-xl font-bold">Data Tagihan & Cicilan</h3>
        <div className="mt-4 bg-white p-3 rounded shadow">
          {bills.map(b => (
            <div key={b.id} className="mb-4">
              <div className="font-semibold text-lg">{b.description}{b.total ? ` - Total Rp ${b.total.toLocaleString()}` : ''}</div>
              {b.installments ? (
                <table className="w-full table-auto mt-2 border-collapse border">
                  <thead>
                    <tr className="border-b">
                      <th className="p-2 text-center">Cicilan</th>
                      <th className="p-2 text-center">Jumlah</th>
                      <th className="p-2 text-center">Status</th>
                      <th className="p-2 text-center">Jatuh Tempo</th>
                      <th className="p-2 text-center">VA</th>
                      <th className="p-2 text-center">Kode Tagihan</th>
                      <th className="p-2 text-center">Deskripsi</th>
                    </tr>
                  </thead>
                  <tbody>
                    {b.installments.map(inst => (
                      <tr key={inst.number} className="border-t hover:bg-gray-50 cursor-pointer" onClick={() => onClickInstallment(inst)}>
                        <td className="p-2 text-center">{inst.number}</td>
                        <td className="p-2 text-center">Rp {inst.amount.toLocaleString()}</td>
                        <td className={`p-2 ${inst.status === 'Belum Lunas' ? 'text-red-600' : 'text-green-600'}`}>{inst.status}</td>
                        <td className="p-2 text-center">{inst.dueDate || '-'}</td>
                        <td className="p-2 text-center">{inst.va}</td>
                        <td className="p-2 text-center">{inst.billCode}</td>
                        <td className="p-2 text-center">{inst.detail}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              ) : (
                <div className="text-sm mt-1">Rp {b.amount?.toLocaleString()} - {b.status}</div>
              )}
            </div>
          ))}
        </div>
      </div>
    );
  }

  function PengumumanView() {
    return (
      <div className="p-6">
        <h3 className="text-xl font-bold">Pengumuman</h3>
        <div className="mt-4 grid gap-3">
          {announcements.map(a => (
            <div key={a.id} className="p-3 border rounded bg-white">
              <div className="flex justify-between items-center">
                <div>
                  <div className="font-semibold">{a.title}</div>
                  <div className="text-xs opacity-70">{a.date}</div>
                </div>
              </div>
              <div className="mt-2 text-sm">{a.body}</div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  function ProfileView() {
    return (
      <div className="p-6">
        <h3 className="text-xl font-bold">Profil Mahasiswa</h3>
        <div className="mt-4 bg-white p-4 rounded shadow">
          <div className="text-sm">Nama: {dashboard?.name}</div>
          <div className="text-sm">NIM: {dashboard?.nim}</div>
          <div className="text-sm">Prodi: {dashboard?.prodi}</div>
          <div className="mt-3">
            <button className="border px-3 py-2 rounded">Edit Profil (placeholder)</button>
          </div>
        </div>
      </div>
    );
  }

  // -------------------- Render --------------------
  return (
    <div className="min-h-screen bg-gray-100">
      <Nav />
      <main className="max-w-6xl mx-auto">
        {!token && route === "/login" && <Login />}
        {token && route === "/dashboard" && <DashboardView />}
        {token && route === "/krs" && <KRSView />}
        {token && route === "/nilai" && <NilaiView />}
        {token && route === "/jadwal" && <JadwalView />}
        {token && route === "/tagihan" && <TagihanView />}
        {token && route === "/pengumuman" && <PengumumanView />}
        {token && route === "/profile" && <ProfileView />}
      </main>
      <footer className="text-center text-sm text-gray-500 p-6">
        © {new Date().getFullYear()} UNIVERSITAS KRISNADWIPAYANA - SIMAK
      </footer>
    </div>
  );
}
